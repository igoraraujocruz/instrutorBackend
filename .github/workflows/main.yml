name: CI

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            cd ~/instrutorBackend

            echo "Pulling latest code..."
            git pull origin master

            echo "Installing dependencies..."
            yarn

            echo "Generating Prisma Client..."
            npx prisma generate

            echo "Running migrations..."
            npx prisma migrate deploy

            echo "Building application..."
            yarn build

            echo "Restarting PM2..."
            pm2 restart server --update-env || pm2 start dist/index.js --name server
